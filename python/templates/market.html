<html>
<head>
    <title>Trading Game Market Phase</title>
    <style>
        table {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
        }

        td,
        th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        tr:hover {
            background-color: #f2f2f2;
        }

        th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #00d9ff;
            color: rgb(0, 0, 0);
        }

        .wrapper {
            display: flex;
            justify-content: space-between;
        }

    </style>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"
        integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H"
        crossorigin="anonymous"></script>
</head>
<body>

<p id="clock"></p>
<p id="user" style="display: none">{{ user }}</p>
time remaining:
<p id="time_left"></p>
net position: <p id="position">0</p>
<br><br>
<div class="wrapper">
<div id="ladder">
</div>
<table id="trades-table">
<thead> 
    <tr>
        <th>passive user</th>
        <th>passive side</th>
        <th>trade qty</th>
        <th>trade px</th>
        <th>trade pnl</th>
    </tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<script>
    const socket = io();

    socket.on("tick", (msg) => {
        console.log("tick, msg=", msg);
        let data = JSON.parse(msg);
        let clock = document.getElementById("clock");
        clock.innerHTML = data["dt"];

        if ("market_time_left" in data) {
            let time_ele = document.getElementById("time_left");
            time_ele.innerHTML = data["market_time_left"];
        }
    });

    socket.on("book", (msg) => {
        console.log("book, msg=", msg);
        let data = JSON.parse(msg);
        let rows = data['rows'];
        let columns = data['columns'];
        let grid = data['grid'];
        let user = data['player'];

        if (user === document.getElementById("user").innerHTML) {
            let table = document.createElement('table');
            let thead = document.createElement('thead');
            let tbody = document.createElement('tbody');
            table.appendChild(thead);
            table.appendChild(tbody);
    
            let hr = document.createElement('tr');
            let hr1 = document.createElement('th');
            let hr2 = document.createElement('th');
            let hr3 = document.createElement('th');
            let hr4 = document.createElement('th');
            let hr5 = document.createElement('th');
            
            hr1.innerHTML = 'your bid qty';
            hr2.innerHTML = 'market bid qty';
            hr3.innerHTML = 'price';
            hr4.innerHTML = 'market ask qty';
            hr5.innerHTML = 'your ask qty';
            
            hr.append(hr1);
            hr.append(hr2);
            hr.append(hr3);
            hr.append(hr4);
            hr.append(hr5);
            thead.append(hr);
    
            for (const row of rows) {
                let tr = document.createElement('tr');
                console.log("rending row=", row);
                for (const [column, value] of Object.entries(grid[row])) {
                    let td = document.createElement('td');
                    td.innerHTML = value;
    
                    td.onclick = (() => {
                        handle_click(row, column);
                    });
    
                    td.oncontextmenu = (() => {
                        handle_right_click(row, column);
                        return false;
                    });
    
                    tbody.appendChild(td);
                }
                tbody.appendChild(tr);
            }
    
            let ladder = document.getElementById('ladder');
            ladder.removeChild(ladder.firstChild);
            ladder.appendChild(table);
        } else {
            console.log("not updating book html because got user=", user);
        }        
    });

    socket.on("position", (msg) => {
        console.log("position, msg=", msg);
        let data = JSON.parse(msg);
        let user = data['player'];
        if (user === document.getElementById("user").innerHTML) {
            let pos_ele = document.getElementById("position");
            pos_ele.innerHTML = data['position'];
        }
    });


//    socket.on("trade", (msg) => {
//        console.log("trade, msg=", msg);
//        let data = JSON.parse(msg);
//        let trades = document.getElementById('trades');
//        let div = document.createElement('div');
//        div.innerHTML = "[" + data['passive_account'] + "] " + data["passive_side"] + " " + data["volume"] + " @ " + data["price"];
//        trades.appendChild(div);
//    });

    socket.on("trade", (msg) => {
        console.log("trade, msg=", msg);
        let data = JSON.parse(msg);
        var tbody_ref = document.getElementById('trades-table').getElementsByTagName('tbody')[0];
        
        let html_content = "<tr><td>" + data["passive_account"] + "</td><td>" + data["passive_side"] + "</td><td>" + data["volume"] + "</td><td>" + data["price"] + "</td></tr>";
        var new_row = tbody_ref.insertRow(tbody_ref.rows.length);
        new_row.innerHTML = html_content;
    });

    socket.on("end_market_game", (msg) => {
        window.location.href = "{{ url_for('results') }}";
    });


    function handle_click(row, column) {
        console.log("handle_click, row=", row, ", column=", column);
        let user_name = document.getElementById("user").innerHTML;
        let payload = {
            user: user_name,
            row: row,
            column: column
        };
        socket.emit("handle_click", JSON.stringify(payload));
    }

    function handle_right_click(row, column) {
        console.log("handle_right_click, row=", row, ", column=", column);
        let user_name = document.getElementById("user").innerHTML;
        let payload = {
            user: user_name,
            row: row,
            column: column
        };
        socket.emit("handle_right_click", JSON.stringify(payload));        
    }
    

</script>

</body>
</html>